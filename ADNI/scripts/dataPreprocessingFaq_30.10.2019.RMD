---
title: "dataPreprocessing_30.10.2019"
date: "10/30/2019"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
knitr::opts_knit$set(root.dir = '/Users/Meems/Documents/PhDWork/Publications/3rd Paper/')
print(getwd())
```

##adni data##
```{r}
load(paste(getwd(), "/ADNI data/ADNIDownloaded'19/Study_Info/ADNIMERGE_0.0.1/ADNIMERGE/data/datadic.rdata", sep = ""))
adnimerge$long.age <- round((adnimerge[,"AGE"] + adnimerge[,"Years.bl"]), digits =1)
```

```{r}
ecog = colnames(adnimerge[,grep("Ecog(?!.*bl)", colnames(adnimerge), perl = TRUE)])
impFeatures = c("MMSE", "CDRSB", "ADAS11", "ADAS13", "FAQ", ecog)
impFeaturesDf = adnimerge[,c("RID", "VISCODE", "Month", impFeatures)]
```

##number of patients##
```{r}
length(unique(adnimerge$RID))
```

##diagnostic distribution at baseline##
```{r}
print("All patients in total are:")
adnimergeAtBl = subset(adnimerge, adnimerge$Month == 0)
length(unique(adnimergeAtBl$RID))
table(adnimergeAtBl$DX.bl)
```

```{r}
##extract the patients that have been diagnosed with AD atleast at one visit
aggDiagnosis <- ddply(adnimerge, .(RID), summarize, DX = toString(DX))
patientid <- c()
for(i in 1:nrow(aggDiagnosis)){
  if(grepl("Dementia", aggDiagnosis[i,2])){
      patientid <- c(patientid, aggDiagnosis[i,1])
  }
}
atleastOneADdf <- adnimerge[which(adnimerge$RID %in% patientid),]
aggDiagnosisAD <- ddply(atleastOneADdf, .(RID), summarize, DX = toString(DX))

##patients with atleast one MCI who have atleast one AD
patientidMCI <- c()
for(i in 1:nrow(aggDiagnosisAD)){
  if(grepl("MCI", aggDiagnosisAD[i,2])){
      patientidMCI <- c(patientidMCI, aggDiagnosisAD[i,1])
  }
}
atleastOneMCIdf <- atleastOneADdf[which(atleastOneADdf$RID %in% patientidMCI),]
aggDiagnosisMCI <- ddply(atleastOneMCIdf, .(RID), summarize, DX = toString(DX))


patientidConv <- c()
for(i in 1:nrow(aggDiagnosisMCI)){
  if(grepl("^Dementia(.*MCI|.*\\,\\sMCI|\\,\\sMCI|.*\\,\\sMCI$|.*CN|.*\\,\\sCN|\\,\\sCN|.*\\,\\sCN$)", aggDiagnosisMCI[i,2])){
      patientidConv <- c(patientidConv, aggDiagnosisMCI[i,1])
  }
   if(grepl("^MCI(.*CN|\\,\\sCN|.*\\,\\sCN|.*\\,\\sMCI$)", aggDiagnosisMCI[i,2])){
      patientidConv <- c(patientidConv, aggDiagnosisMCI[i,1])
   }
     if(grepl("^CN.*Dementia(.*CN|\\,\\sCN|.*\\,\\sCN|.*\\,\\sMCI$)", aggDiagnosisMCI[i,2])){
      patientidConv <- c(patientidConv, aggDiagnosisMCI[i,1])
  }
}
##remove these ids from the df as they are reverting to MCI or CTL from AD and CTL from MCI##
finalDf <- atleastOneMCIdf[which(!atleastOneMCIdf$RID %in% patientidConv),]
length(unique(finalDf$RID))
```

###Number of Diagnosed MCI###
```{r}
length(unique(aggDiagnosisMCI$RID))
```

###Number of Diagnosed AD###
```{r}
length(unique(aggDiagnosisAD$RID))
```

##delete the patients with just one time point##
```{r}
func.del.patients.single.time.point <- function(data){
  library(plyr)
  aggVisit <- ddply(data, .(RID), summarize, Month = toString(Month))
  data <- subset(data,!data$RID 
                 %in%aggVisit[which(count.fields(textConnection((aggVisit[,"Month"])), sep = ",")== 1), 1])
  return(data)
}
finalDf <- func.del.patients.single.time.point(finalDf)
length(unique(finalDf$RID))
```


##Diagnosis Count After Removal of Patients with One Time Point (Excluding 1 timepoint DX)##
```{r}
summaryDiagnosis <- ddply(finalDf, .(RID), summarize, DX = toString(DX))

onlyCN_s <- c()
onlyDementia_s <- c()
convertMCItoDementia_s <- c()
convertCNtoMCI_s <- c()
directCNtoDementia_s <- c()
convertCNtoMCItoDementia_s <- c()
onlyMCI_s <- c()
for(i in 1:nrow(summaryDiagnosis)){
  if(grepl("^(?!.*MCI|Dementia)^CN.*(CN|NA)$",summaryDiagnosis[i,2],perl=TRUE)){
    onlyCN_s <- c(onlyCN_s, summaryDiagnosis[i,1])
  }
  if(grepl("^(?!.*MCI)^Dementia.*(Dementia|NA)$",summaryDiagnosis[i,2],perl=TRUE)){
    onlyDementia_s <- c(onlyDementia_s, summaryDiagnosis[i,1])
  }
  if(grepl("^(?!.*CN)^MCI.*(Dementia|NA)$",summaryDiagnosis[i,2], perl=TRUE)){
    convertMCItoDementia_s <- c(convertMCItoDementia_s, summaryDiagnosis[i,1])
  }
  if(grepl("^(?!.*Dementia)^CN.*(MCI|NA)$",summaryDiagnosis[i,2],perl=TRUE)){
    convertCNtoMCI_s <- c(convertCNtoMCI_s, summaryDiagnosis[i,1])
  }
  if(grepl("^(?!.*MCI)^CN.*(Dementia|NA)$",summaryDiagnosis[i,2], perl=TRUE)){
    directCNtoDementia_s <- c(directCNtoDementia_s, summaryDiagnosis[i,1])
  }
  if(grepl("^CN.*MCI.*(Dementia|NA)$",summaryDiagnosis[i,2], perl=TRUE)){
    convertCNtoMCItoDementia_s <- c(convertCNtoMCItoDementia_s, summaryDiagnosis[i,1])
  }
  if(grepl("^(?!.*CN|Dementia)^MCI.*(MCI|NA)$",summaryDiagnosis[i,2],perl=TRUE)){
    onlyMCI_s <- c(onlyMCI_s, summaryDiagnosis[i,1])
  }
}
selectedIDS_s <- c(onlyDementia_s,convertMCItoDementia_s,directCNtoDementia_s,convertCNtoMCI_s,
                 convertCNtoMCItoDementia_s,onlyMCI_s,onlyCN_s)
```

```{r}
##DX Count##
print("Patients diagnosed only as CN")
cn_length <- length(onlyCN_s)
print(cn_length)
print("Patients converting from CN to MCI")
cnToMCI <- length(convertCNtoMCI_s)
print(cnToMCI)
print("Patients converting directly from CN to Dementia")
cnToDementia <- length(directCNtoDementia_s)
print(cnToDementia)
print("Patients converting from CN to MCI to Dementia")
cnToMciToDementia <- length(convertCNtoMCItoDementia_s)
print(cnToMciToDementia)
print("Patients diagnosed only with MCI")
mci_length <- length(onlyMCI_s)
print(mci_length)
print("Patients converting from MCI to Dementia")
mciToDementia <- length(convertMCItoDementia_s)
print(mciToDementia)
print("Patients diagnosed only with Dementia")
dementia_length <- length(onlyDementia_s)
print(dementia_length)
groups <- c("CN to MCI","Only CN","CN-MCI-Dementia","Only MCI","MCI to Dementia","Only Dementia","Direct CN to MCI")
values <- c(cnToMCI,cn_length,cnToMciToDementia,mci_length,mciToDementia,dementia_length,cnToDementia)
print("Total Sum")
print(sum(values))
``` 

##patients left after removal of patients at one time point##
```{r}
table(finalDf$DX)
print("All patients in total are:")
length(unique(finalDf$RID))
```

##extract only cognitive scores from adnimerge##
```{r}
finalDf <- finalDf[,c("RID", "VISCODE", "ORIGPROT", "COLPROT", "EXAMDATE", "long.age", "FAQ", "MMSE", "CDRSB", "ADAS11", "ADAS13","EcogPtTotal")]
```

```{r}
colMeans(is.na(finalDf))
missingValuesFeaturesImp = as.data.frame(colMeans(is.na(finalDf)))
names(missingValuesFeaturesImp)[names(missingValuesFeaturesImp) == "colMeans(is.na(finalDf))"] = "missingValuePerc"
```

##merge adas individual scores to the table##
```{r}
##for ADNI
##subset adas table for subscores Q scores:
load(paste(getwd(), "/ADNI data/ADNIDownloaded'19/Study_Info/ADNIMERGE_0.0.1/ADNIMERGE/data/adas.rdata", sep = ""))
adas$VISCODE[adas$RID == "1052" & adas$USERDATE == "2019-04-02"] <- "m156" #This is hard coded as it's a mistake in original dataset.
adas$VISCODE[adas$RID == "4175" & adas$USERDATE == "2019-04-24"] <- "m96"
adas$VISCODE[adas$RID == "4926" & adas$USERDATE == "2019-03-20"] <- "m81"
adasSubSetAdni = adas[,c("RID", "VISCODE", "ORIGPROT", "COLPROT", grep("Q[0-9]*SCORE$", colnames(adas), value =TRUE))]
##memory: add Q1SCORE, Q4SCORE, Q7SCORE, Q8SCORE, Q9SCORE
adasSubSetAdni$ADAS_Memory = rowSums(adasSubSetAdni[,grep("Q(1|4|7|8|9)SCORE$", colnames(adasSubSetAdni), value = TRUE)])
##language: add Q2SCORE, Q5SCORE, Q10SCORE, Q11SCORE, Q12SCORE
adasSubSetAdni$ADAS_Language = rowSums(adasSubSetAdni[,grep("Q(2|5|10|11|12)SCORE$", colnames(adasSubSetAdni), value = TRUE)])
##praxis: add Q3SCORE, Q6SCORE 
adasSubSetAdni$ADAS_Praxis = rowSums(adasSubSetAdni[,grep("Q(3|6)SCORE$", colnames(adasSubSetAdni), value = TRUE)])
##concentration:  Q13SCORE
adasSubSetAdni$ADAS_Concentration = adasSubSetAdni[,"Q13SCORE"]
adasVarsADNI = adasSubSetAdni[,c("RID", "VISCODE", "ORIGPROT", "COLPROT", "ADAS_Memory", "ADAS_Language", "ADAS_Praxis", "ADAS_Concentration")]
combinedDataADNI <- merge(adasVarsADNI, finalDf,by = c("RID", "VISCODE", "ORIGPROT", "COLPROT"))
##remove patients who have ADAS13 greater than 78
combinedDataADNI <- combinedDataADNI[which(combinedDataADNI$ADAS13 <= 78),]
combinedDataADNI
length(unique(combinedDataADNI$RID))
```


##check the missing value percentage of each feature##
```{r}
colMeans(is.na(combinedDataADNI))
```

##faq data##
```{r}
load("/Users/Meems/Documents/PhDWork/Publications/3rd Paper/ADNI data/ADNIDownloaded'19/Study_Info/ADNIMERGE_0.0.1/ADNIMERGE/data/faq.rdata")
faq$VISCODE[faq$RID == "1052" & faq$USERDATE == "2019-03-29"] <- "m156"
faq$VISCODE[faq$RID == "4175" & faq$USERDATE == "2019-03-18"] <- "m96"
faq$VISCODE[faq$RID == "5075" & faq$USERDATE == "2018-12-05"] <- "m72"
faq$VISCODE[faq$RID == "4926" & faq$USERDATE == "2019-03-21"] <- "m81"
faq[2308,5] <- "m106"
print("Number of Patients:")
length(unique(faq$RID))
```

##faq preprocessing##
```{r}
library(dplyr)
library(stringr)
faqRelevant <- faq[,c("RID","VISCODE","ORIGPROT","COLPROT","FAQFINAN","FAQFORM","FAQSHOP","FAQGAME","FAQBEVG","FAQMEAL","FAQEVENT","FAQTV","FAQREM","FAQTRAVL","FAQTOTAL")]
faqTests <- faqRelevant %>% select(starts_with("FAQ"))
faqTests<- colnames(faqTests)
num.extract <- function(string){
  str_extract(string, "\\-*\\d+\\.*\\d*")
  string <- as.numeric(str_extract(string, "\\-*\\d+\\.*\\d*"))
}
faqRelevant[,c(faqTests)] <- lapply(faqRelevant[,c(faqTests)],num.extract)
combinedAdniFaq <- merge(combinedDataADNI, faqRelevant, by = c("RID","VISCODE", "ORIGPROT", "COLPROT"))
combinedAdniFaq
length(unique(combinedAdniFaq$RID))
```


```{r}
##vector of all cognitive tests##
func.normalize <- function(data){
  normalizedData <- data
  normalizedData <- as.data.frame(normalizedData)
  if("ADAS_COG" %in% colnames(data)){
      normalizedData$ADAS_COG <- normalizedData$ADAS_COG/70
  }
  if("ADAS11" %in% colnames(data)){
      normalizedData$ADAS11 <- normalizedData$ADAS11/70
  }
  if("ADAS13" %in% colnames(data)){
      normalizedData$ADAS13 <- normalizedData$ADAS13/78
  }
  if("ADAS_Memory" %in% colnames(data)){
      normalizedData$ADAS_Memory <- normalizedData$ADAS_Memory/45
  }
  if("ADAS_Language" %in% colnames(data)){
      normalizedData$ADAS_Language <- normalizedData$ADAS_Language/25
  }
  if("ADAS_Praxis" %in% colnames(data)){
      normalizedData$ADAS_Praxis <- normalizedData$ADAS_Praxis/10
  }
  if("ADAS_Concentration" %in% colnames(data)){
      normalizedData$ADAS_Concentration <- normalizedData$ADAS_Concentration/5
  }
  if("ADCS_ADL" %in% colnames(data)){
    normalizedData$ADCS_ADL <- 1-normalizedData$ADCS_ADL/78
  }
  if("CDR_SOB"%in% colnames(data)){
      normalizedData$CDR_SOB <- normalizedData$CDR_SOB/18
 }
  if("CDRSB" %in% colnames(data)){
      normalizedData$CDRSB <- normalizedData$CDRSB/18
  }
  if("CDR_Total" %in% colnames(data)){
      normalizedData$CDR_Total <- normalizedData$CDR_Total/3
  }
  if("Hachinski" %in% colnames(data)){
     normalizedData$Hachinski <- 1-normalizedData$Hachinski/8
  }
  if("MMSE" %in% colnames(data)){
      normalizedData$MMSE <- 1-normalizedData$MMSE/30
  }
  if("CERAD_B_Total" %in% colnames(data)){
      normalizedData$CERAD_B_Total <- 1-normalizedData$CERAD_B_Total/15
  }
  if("CERAD_E_Correct" %in% colnames(data)){
    normalizedData$CERAD_E_Correct <- 1-normalizedData$CERAD_E_Correct/10
  }
  if("CERAD_E_Intrusions" %in% colnames(data)){
      normalizedData$CERAD_E_Intrusions <- 1-normalizedData$CERAD_E_Intrusions/10  
  }
  if("Cant_Read_Total" %in% colnames(data)){
    normalizedData$Cant_Read_Total <- 1-normalizedData$Cant_Read_Total/10
  }
  if("Geriatric_Depression" %in% colnames(data)){
    normalizedData$Geriatric_Depression <- normalizedData$Geriatric_Depression/15     
  }
  if("Sensory_Impairment" %in% colnames(data)){
      normalizedData$Sensory_Impairment <- normalizedData$Sensory_Impairment/13   
  }  
  if("FAQFINAN" %in% colnames(data)){
    normalizedData$FAQFINAN <- normalizedData$FAQFINAN/3
  }
  if("FAQFORM" %in% colnames(data)){
    normalizedData$FAQFORM <- normalizedData$FAQFORM/3
  }
  if("FAQSHOP" %in% colnames(data)){
    normalizedData$FAQSHOP <- normalizedData$FAQSHOP/3
  }
  if("FAQGAME" %in% colnames(data)){
    normalizedData$FAQGAME <- normalizedData$FAQGAME/3
  }
  if("FAQBEVG" %in% colnames(data)){
    normalizedData$FAQBEVG <- normalizedData$FAQBEVG/3
  }
  if("FAQMEAL" %in% colnames(data)){
    normalizedData$FAQMEAL <- normalizedData$FAQMEAL/3
  }
  if("FAQEVENT" %in% colnames(data)){
    normalizedData$FAQEVENT <- normalizedData$FAQEVENT/3
  }
  if("FAQTV" %in% colnames(data)){
    normalizedData$FAQTV <- normalizedData$FAQTV/3
  }
  if("FAQREM" %in% colnames(data)){
    normalizedData$FAQREM <- normalizedData$FAQREM/3
  }
  if("FAQTRAVL" %in% colnames(data)){
    normalizedData$FAQTRAVL <- normalizedData$FAQTRAVL/3
  }
  if("FAQTOTAL" %in% colnames(data)){
    normalizedData$FAQTOTAL <- normalizedData$FAQTOTAL/30
  }
  return(normalizedData)
}
faqAdasDataADNI <- combinedAdniFaq[,c("RID", "long.age", "VISCODE", "ADAS13", "ADAS11", "ADAS_Memory", "ADAS_Language", "ADAS_Praxis", "ADAS_Concentration", "CDRSB", "MMSE","FAQFINAN","FAQFORM","FAQSHOP","FAQGAME","FAQBEVG","FAQMEAL","FAQEVENT",
                      "FAQTV","FAQREM","FAQTRAVL","FAQTOTAL")]
normDataADNI <- func.normalize(faqAdasDataADNI)
normDataADNI
length(unique(normDataADNI$RID))
```

```{r}
##Counting NAs##
na_count <-sapply(combinedAdniFaq, function(y) sum(length(which(is.na(y)))))
na_count <- data.frame(na_count)
na_count
```


#faq data to be entered to the model
```{r}
##Missing value percentage
missingValueWithFaq = as.data.frame(colMeans(is.na(normDataADNI)))
names(missingValueWithFaq)[names(missingValueWithFaq) == "colMeans(is.na(normDataADNI))"] = "missingValuePerc"
names(normDataADNI)[names(normDataADNI) == "long.age"] = "TIME"
cofactorADNIwithFAQ = merge(normDataADNI, adnimerge[,c("PTID","PTEDUCAT", "PTETHCAT", "PTGENDER", "PTMARRY", "PTRACCAT", "VISCODE", "RID", "APOE4")], by = c("RID", "VISCODE"))
names(normDataADNI)[names(normDataADNI) == "RID"] = "ID"
names(cofactorADNIwithFAQ)[names(cofactorADNIwithFAQ) == "RID"] = "ID"
#inputDataADNIwithFAQ = postNAnormalized[,c(1:)]
normDataADNI = normDataADNI[,c(1,2,4:22)]
cofactorADNIwithFAQ = cofactorADNIwithFAQ[,c(1,3:29)]
write.csv(normDataADNI, file =("/Users/Meems/leaspyExps/data/inputDataADNIFAQUpd.csv"), row.names=FALSE)
write.csv(cofactorADNIwithFAQ, file =("/Users/Meems/leaspyExps/data/cofactorADNIwithFAQ.csv"), row.names=FALSE)
  # write.table(normDataADNI, file =paste(getwd(), "/ResultsUpdated/ADNIwithFaq/inputDataADNIFAQUpd.csv", sep = "") , row.names=FALSE, sep=",")
# write.table(cofactorADNIwithFAQ, file = paste(getwd(), "/ResultsUpdated/ADNIwithFaq/cofactorADNIwithFAQ.csv", sep   = "") ,row.names=FALSE, sep=",")
```

