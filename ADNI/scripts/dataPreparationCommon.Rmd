---
title: "dataPreparation"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#knitr::opts_knit$set(root.dir = '/Users/Meems/Documents/PhDWork/Publications/3rd Paper/')
knitr::opts_knit$set(root.dir = getwd())
getwd()
#knitr::opts_knit$set(root.dir = '/Users/Meems/Documents/PhDWork/RADAR-AD/DESCRIPA/')
```
##Load all the possible libraries
```{r}
library(plyr)
library(readr)
```

##Input the data set to be processed
```{r ,  echo=FALSE, include=FALSE}
func.input.data <- function()
{
  user_input <- "Which dataset do you want to process: 
  1. ADNI
  2. AddNeuroMed (ANM)
  3. DESCRIPA
  4. PROTECT
  5. EPAD
  "
  type_of_data <- readline(prompt = user_input)
  if(!type_of_data %in% c("ADNI", "AddNeuroMed (ANM)", "DESCRIPA", "PROTECT", "EPAD")){
    print("Incorrect data set name")
  }
  return(type_of_data)
}
input_data <- func.input.data()

if(input_data == "ADNI"){
  #load(paste(getwd(),"/inputDataSets/adnimerge.rdata", sep = ""))
  load(paste(getwd(), "/ADNIMERGE - 23.10.2019/ADNIMERGE/data/adnimerge.rdata", sep = ""))
  inputData = adnimerge
}

if(input_data == "AddNeuroMed (ANM)"){
  inputData = read_csv(paste(getwd(),"/inputDataSets/anm.csv", sep = ""))
}

if(input_data == "DESCRIPA"){
  inputData = read_csv(paste(getwd(),"/inputDataSets/DESCRIPAdata.csv", sep = ""))
}

if(input_data == "PROTECT"){
  inputData = read_csv(paste(getwd(),"/inputDataSets/protectMerge.csv", sep = ""))
}

# if(input_data == "EPAD"){
#   inputData = read_csv(paste(getwd(),"/inputDataSets/protectMerge.csv", sep = ""))
# }

```


##remove the unused variables##
```{r}
func.unused.variables <- function(inputData, input_data){
  if(input_data=="AddNeuroMed (ANM)"){
    unusedVaribales <- c("X1", "Sadman_ID", "Site", "Baseline_Date", "BL_Date", "Visit_Date", "DEMQOL", "Father_Dementia", "Mother_Dementia", "Date_Of_Birth", "Global_Deterioration_Scale", "Progression_Pattern",
"SNP_batch", "Onset_Year")
    inputData[,unusedVaribales] <- NULL
  }
if(input_data=="DESCRIPA"){
    unusedVaribales <- c("X1", "aaaregnr", "regnr", "amn15", grep("Type", colnames(inputData), value = TRUE))
    inputData[,unusedVaribales] <- NULL
   }
  return(inputData)
}

inputData = func.unused.variables(inputData, input_data)
```


##correct the age in the data, changing the age to baseline age and adding longitudinal age
```{r, include=FALSE}
func.age.correction <- function(inputData, input_data){
  if(input_data == "AddNeuroMed (ANM)"){
    ##Remove the other ages in the cells except the age at baseline
    inputData = within(inputData, {Age = ifelse(Month == 0, Age, NA)})
    library(zoo)
    inputData$Age <- na.locf(inputData$Age)
    ##adding longitudinal age to the data
    inputData[,"Age"] <- round((inputData[,"Age"] + (inputData[,"Month"]/12)), digits =1)
    inputData <- as.data.frame(inputData)
  }
    if(input_data == "ADNI"){
      inputData$long.age <- round((inputData[,"AGE"] + inputData[,"Years.bl"]), digits =1)
    }
   return(inputData)
}

inputData = func.age.correction(inputData, input_data)
```

##Function to extract the column indexes consisting of demographic information##
```{r, warning=FALSE}
func.demog.id <- function(inputData){
  id <- grep(".*ID$", names(inputData), value=TRUE)
  #id_idx <- which(colnames(inputData) %in% id)
  if(length(id)>1){
    id_idx <- which(colnames(inputData) %in% id[2])
  }
  # names(inputData)[names(inputData)==id] == "Subject_ID"
  # id <- "Subject_ID"
  time_period <- c("M", "Month", "month", "Time", "time", "Years")
  time <-  colnames(inputData)[which(names(inputData) %in% time_period)]
  if(length(time)>1){
    time_idx <- which(colnames(inputData) %in% time[1])
  }
  else{
     time_idx <- which(colnames(inputData) %in% time)
  }
  visit_id <- c("VISCODE", "visit", "VISIT")
  visit <-  colnames(inputData)[which(names(inputData) %in% visit_id)]
  visit_idx <- which(colnames(inputData) %in% visit)
  prm_key <- c("primary_key", "primary_key1", "primary_key2")
  pk <- colnames(inputData)[which(names(inputData) %in% prm_key)]
  pk_id <- which(colnames(inputData) %in% pk)
  age <- c("Age", "age", "AGE")
  age_col <- colnames(inputData)[which(names(inputData) %in% age)]
  age_idx <- which(colnames(inputData) %in% age_col)
  diagnosis_bl <- c("DX.bl", "Diagnosis.bl", "Stage.bl")
  diag_bl <-  colnames(inputData)[which(names(inputData) %in% diagnosis_bl)]
  diag_bl_idx <- which(colnames(inputData) %in% diag_bl)
  diagnosis <- c("DX", "Diagnosis", "Stage")
  diag <-  colnames(inputData)[which(names(inputData) %in% diagnosis)]
  diag_idx <- which(colnames(inputData) %in% diag)
  names(inputData)[names(inputData)==diag] = "Diagnosis"
  diag <- "Diagnosis"
  education <- c("Education", "EDUCATION", "PTEDUCAT", "Fulltime_Education_Years")
  edu <-  colnames(inputData)[which(names(inputData) %in% education)]
  edu_idx <- which(colnames(inputData) %in% edu)
  names(inputData)[names(inputData)==edu] = "Education"
  edu <- "Education"
  gender <- c("GENDER", "PTGENDER", "Gender") 
  gen <-  colnames(inputData)[which(names(inputData) %in% gender)]
  gen_idx <- which(colnames(inputData) %in% gen)
  ethnicity <- c("PTETHCAT", "ethinicity", "ethics")
  eth <-  colnames(inputData)[which(names(inputData) %in% ethnicity)]
  eth_idx <- which(colnames(inputData) %in% eth)
  race <- c("PTRRACAT", "RACE", "race", "Race")
  race_col <-  colnames(inputData)[which(names(inputData) %in% race)]
  race_idx <- which(colnames(inputData) %in% race_col)
  marital_status <- c("PTMARRY", "MARRIED", "Married", "married", "MARRY", "Marital_Status")
  marital <-  colnames(inputData)[which(names(inputData) %in% marital_status)]
  marital_idx <- which(colnames(inputData) %in% marital)
  names(inputData)[names(inputData)==marital] == "Marital_Status"
  marital <- "Marital_Status"
  demog_cols <- c(id, time,visit, pk, age_col, diag_bl, diag, edu, gen, eth, race_col, marital)
  if(length(pk_id == 2)){
    pk_upd <- c(pk_id[1], pk_id[2])
  }
  else{
    pk_upd <- pk_id
  }
  demog_col_id <- c(id_idx,time_idx,visit_idx,pk_upd, age_idx, 
                    diag_bl_idx, diag_idx, edu_idx, gen_idx, eth_idx, race_idx, marital_idx)
  #print(colnames(inputData))
  return(list(inputData,demog_col_id, demog_cols))
}

demog_list <- func.demog.id(inputData)  
demog_cols <- demog_list[3]
demog_cols
inputData <- as.data.frame(demog_list[1])

```


##Summary of Data 
```{r}
func.data.summary <- function(inputData){
  inputDataBl = subset(inputData, inputData$Month == 0)
  print("All patients in total are:")
  length(unique(inputDataBl$PTID))
  print(table(inputDataBl$Diagnosis))
  ##Number of the patients not starting at baseline
  inputDataAgg <- ddply(inputData, .(PTID), summarize, Month = toString(Month))
  inputDataNotAtBl = inputDataAgg$PTID[!grepl("0", inputDataAgg$Month)]
  print(paste("The patients not starting at baseline", length(inputDataNotAtBl), sep = " "))
}

func.data.summary(inputData)
```

##Choose which type of measures you want to do pattern analysis for
```{r}
func.typeof.data <- function()
{
  user_input <- "Do you want to do trajectory predictions  for : 
  1. DeNovo
  2. Control
  3. MCIandDementia
  4. WithADLDementia
  5. WithDigital
  "
  type_of_data <- readline(prompt = user_input)
  if(!type_of_data %in% c("DeNovo", "Control", "MCIandDementia", "WithADLDementia", "WithDigital")){
    print("Incorrect diagnosis name")
  }
  return(type_of_data)
}
type_of_data <- func.typeof.data()
```


##extract the subset according to your input##
```{r}
#func.subset <- function(){
aggDiagnosis <- ddply(inputData, .(PTID), summarize, Diagnosis = toString(Diagnosis))
func.revert <- function(aggDf){
    patientidConv <- c()
for(i in 1:nrow(aggDf)){
    if(grepl("^Dementia(.*MCI|.*\\,\\sMCI|\\,\\sMCI|.*\\,\\sMCI$|.*CN|.*\\,\\CN|\\,\\CN|.*\\,\\sCN$)", aggDf[i,2])){
      patientidConv <- c(patientidConv, aggDf[i,1])
    }
    if(grepl("^MCI(.*CN|\\,\\sCN|.*\\,\\sCN|.*\\,\\sMCI$)", aggDf[i,2])){
      patientidConv <- c(patientidConv, aggDf[i,1])
    }
   if(grepl("^MCI(.*MCI.*CN|\\,\\sCN|.*\\,\\sCN|.*\\,\\sMCI$)", aggDf[i,2])){
      patientidConv <- c(patientidConv, aggDf[i,1])
   }
   if(grepl("^Dementia.*MCI.*Dementia$", aggDf[i,2], perl  = TRUE)){
      patientidConv <- c(patientidConv, aggDf[i,1])
   }
   if(grepl("^CN.*MCI.*Dementia.*CN$", aggDf[i,2], perl  = TRUE)){
      patientidConv <- c(patientidConv, aggDf[i,1])
   }
   if(grepl("^MCI.*Dementia.*MCI.*Dementia$", aggDf[i,2], perl  = TRUE)){
      patientidConv <- c(patientidConv, aggDf[i,1])
   }
   if(!type_of_data == "MCIandDementia"){
    if(grepl("^CN.*MCI|.*Dementia*CTL$", aggDf[i,2], perl  = TRUE)){
        patientidConv <- c(patientidConv, aggDf[i,1])
    }
  }
}
  print("Patients reverting")
  print(patientidConv)
  return(patientidConv)
}

if(type_of_data == "MCIandDementia"){
  patientid <- c()
  for(i in 1:nrow(aggDiagnosis)){
    if(grepl("Dementia", aggDiagnosis[i,2])){
       patientid <- c(patientid, aggDiagnosis[i,1])
    }
  }
  atleastOneADdf <- inputData[which(inputData$PTID %in% patientid),]
  aggDiagnosisAD <- ddply(atleastOneADdf, .(PTID), summarize, Diagnosis = toString(Diagnosis))
  print("Patients with atleast one AD diagnosis")
  print(length(unique(atleastOneADdf$PTID)))
  print("Total with visits")
  print(nrow(atleastOneADdf))
  patientidMCI <- c()
  for(i in 1:nrow(aggDiagnosisAD)){
    if(grepl("MCI", aggDiagnosisAD[i,2])){
        patientidMCI <- c(patientidMCI, aggDiagnosisAD[i,1])
    }
  }
  atleastOneMCIdf <- atleastOneADdf[which(atleastOneADdf$PTID %in% patientidMCI),]
  print("Patients with atleast one AD and one MCI diagnosis")
  print(length(unique(atleastOneMCIdf$PTID)))
  print("Total with visits")
  print(nrow(atleastOneMCIdf))
  aggDiagnosisMCI <- ddply(atleastOneMCIdf, .(PTID), summarize, Diagnosis = toString(Diagnosis))
  length(unique(aggDiagnosisMCI))
  patientidConv <- func.revert(aggDiagnosisMCI)
  print(patientidConv)
  ##remove these ids from the df as they are recoverting to MCI or CTL from AD and CTL from MCI##
  finalDf <- atleastOneMCIdf[which(!atleastOneMCIdf$PTID %in% patientidConv),]
}

if(type_of_data %in% c("DeNovo","WithADLDementia", "WithDigital")){
  ##patients with subjects having Dementia diagnosis throughout
  onlyDementia <- c()
  for(i in 1:nrow(aggDiagnosis)){
    if(grepl("^(?!.*MCI)^AD.*AD$",aggDiagnosis[i,2],perl=TRUE)){
    onlyDementia <- c(onlyDementia, aggDiagnosis[i,1])
      }
  }
  deNovoDementia <- inputData[which(inputData$Subject_ID %in% onlyDementia),]
  print(paste("Patients with Dementia diagnosis throughout", length(onlyDementia), sep = ":"))
  aggDiagnosisDementia <- ddply(deNovoDementia, .(Subject_ID), summarize, Diagnosis = toString(Diagnosis))
  patientidConv <- func.revert(aggDiagnosisDementia)
  print(paste("Patients that revert from AD to MCI or AD to CTL", length(patientidConv), sep = ":"))
  finalDf <- deNovoDementia[which(!deNovoDementia$Subject_ID %in% patientidConv),]
}

if(type_of_data == "Control"){
  ##control subjects##
  onlyCN<- c()
  for(i in 1:nrow(aggDiagnosis)){
    if(grepl("^(?!.*MCI|AD)^CTL.*CTL$",aggDiagnosis[i,2],perl=TRUE)){
      onlyCN <- c(onlyCN, aggDiagnosis[i,1])
    }
  }
  control <- anm[which(anm$Subject_ID %in% onlyCN),]
  aggDiagnosisControl <- ddply(control, .(Subject_ID), summarize, Diagnosis = toString(Diagnosis))
  patientidConv <- func.revert(aggDiagnosisControl)
  finalDf <- control[which(!control$Subject_ID %in% patientidConv),]
}
length(unique(finalDf$Subject_ID))
```
```{r}
finalDf <- inputData 
```

###extract only cognitive scores from anm and demogrpahics##
```{r}
# if(type_of_data == "WithADLDementia"){
#   finalDf <- finalDf[,c("Subject_ID", "Visit", "Diagnosis", "Month", "Age", "MMSE", "CDR_SOB", "CDR_Total", "ADAS_COG", "ADCS_ADL", "Sex", "APOE", "Education", "Marital_Status")]
# }if(type_of_data == "WithDigital"){
#   finalDf <- finalDf[,c("Subject_ID", "Visit", "Diagnosis", "Month", "Age", "MMSE", "CDR_SOB", "CDR_Total", "ADAS_COG", "ADCS_ADL", "Sex", "APOE", "Education", "Marital_Status")]
# }else{
#   finalDf <- finalDf[,c("Subject_ID", "Visit", "Diagnosis", "Month", "Age", "MMSE", "CDR_SOB", "CDR_Total", "ADAS_COG", "Sex", "APOE", "Education", "Marital_Status")]
# }
```

##merge adas individual scores to the table##
```{r}
merge.adas <- function(inputDf)
{
  load(paste(getwd(), "/adasSubSet.RData", sep = ""))
  adasVars = adasSubSet[,c("entity_id", "ADAS_Memory", "ADAS_Language", "ADAS_Praxis", "ADAS_total_validate")]
  View(adasVars)
  ##checking if all features are missing for a patient
  adasVars$Visit = sub(".*\\_", "", adasVars$entity_id)
  adasVars$entity_id = sub("\\_[0-9]*$", "", adasVars$entity_id)
  ##renaming entity id to subject id 
  colnames(adasVars)[colnames(adasVars) == "entity_id"] = "Subject_ID"
  ##merging adas scores with the preprocessed data with other scores##
  adasVars$Visit <- as.numeric(adasVars$Visit)
  print("memememe")
  print(colnames(adasVars))
  combinedData <- merge(inputDf, adasVars, by = c("Subject_ID", "Visit"))
  print("dhdhd")
  table(subset(combinedData, combinedData$Month == 0)["Diagnosis"])
  ##check the missing value percentage of each feature##
  colMeans(is.na(combinedData))
  return(combinedData)
}
```


##merge MMSE individual scores to the table##
```{r}
merge.mmse <- function(inputDf)
{
  load(paste(getwd(), "/adasSubSet.RData", sep = ""))
  adasVars = adasSubSet[,c("entity_id", "ADAS_Memory", "ADAS_Language", "ADAS_Praxis", "ADAS_total_validate")]
  View(adasVars)
  ##checking if all features are missing for a patient
  adasVars$Visit = sub(".*\\_", "", adasVars$entity_id)
  adasVars$entity_id = sub("\\_[0-9]*$", "", adasVars$entity_id)
  ##renaming entity id to subject id 
  colnames(adasVars)[colnames(adasVars) == "entity_id"] = "Subject_ID"
  ##merging adas scores with the preprocessed data with other scores##
  adasVars$Visit <- as.numeric(adasVars$Visit)
  print("memememe")
  print(colnames(adasVars))
  combinedData <- merge(inputDf, adasVars, by = c("Subject_ID", "Visit"))
  print("dhdhd")
  table(subset(combinedData, combinedData$Month == 0)["Diagnosis"])
  ##check the missing value percentage of each feature##
  colMeans(is.na(combinedData))
  return(combinedData)
}
```
##merge adcs individual scores to the table##
```{r}
if(type_of_data == "WithADLDementia"){
merge.adcs <- function(combinedAdas)
  {
    ##demographic feature names##
  demogs <- c("Subject_ID", "Visit", "Diagnosis", "Month", "Age", "Sex", "APOE", "Education", "Marital_Status")
  print("nac")
  print(demogs)
  ##removing after "_" values in entity id in adcs data and renaming the column##
  load(paste(getwd(), "/ADCSdataSub.RData", sep = ""))
  adcsSubset = ADCSdataSub[,c("entity_id", "adlTotalValidate", "basicADL", "instrumentalADL")]
  #save.image(paste(getwd(), "/Scripts/adcsSubset.RData", sep = ""))
  ##find 
  adcsSubset$Visit = sub(".*\\_", "", adcsSubset$entity_id)
  adcsSubset$entity_id = sub("\\_.*", "",adcsSubset$entity_id)
  colnames(adcsSubset)[colnames(adcsSubset) == "entity_id"] = "Subject_ID"
  ##add adcs features from adcs table##
  combinedData = merge(combinedAdas, adcsSubset, by = c("Subject_ID", "Visit"))
#subset of only features with complete data set##
#reqFeatureSet<- na.omit(combinedData[,c(demogs,"ADAS_COG", "ADCS_ADL", "APOE", "CDR_SOB", "CDR_Total", "Fulltime_Education_Years", "Hachinski", "MMSE", "NPI", "Sensory_Impairment", "Webster", "ADAS_Memory","ADAS_Language", "ADAS_Praxis", "ADAS_total_validate", "basicADL", "instrumentalADL", "adlTotalValidate")])
  combinedDataSub <- combinedData[,c(demogs,"ADAS_COG", "ADCS_ADL", "APOE", "CDR_SOB", "CDR_Total",     "Education", "MMSE", "ADAS_Memory","ADAS_Language", 
                                   "ADAS_Praxis", "ADAS_total_validate", 
                                   "basicADL", "instrumentalADL", "adlTotalValidate")]
  return(combinedDataSub)
}
}
```


##removing columns with more than 50% missing values
```{r}
colMeans(is.na(finalDf))
#finalDf <- func.del.patients.single.time.point(finalDf)

finalDf[, -which(colMeans(is.na(finalDf)) > 0.5)]
```



##delete the patients with just one time point##
```{r}
func.del.patients.single.time.point <- function(data){
  print("gzgzg")
  print(colnames(data))
  library(plyr)
  aggVisit <- ddply(data, .(Subject_ID), summarize, Month = toString(Month))
  #print(aggVisit)
  data<-subset(data,!data$Subject_ID%in%aggVisit[which(count.fields(textConnection((aggVisit[,"Month"])), sep=",")== 1), 1])
  #print(data)
  ##checking the missing values percentage
  print("sooddoddod")
  print(colnames(data))
  print(colMeans(is.na(data)))
  return(data)
}
```

##find diagnosis density##
```{r}
diag.density <- function(data){
  print(table(subset(data, data$Month == 0)["Diagnosis"]))
}
```


##range and desctiption of clinical variables##
```{r}
#1.Alzheimer’s Disease (AD) Assessment Scale-Cognitive Subscale (ADAS-Cog) (ADAS-11 in AddNeuroMed data)
#gold standard for assessing the efficacy of antidementia treatments
#range 0-70
##Higher ADAS-Cog on abnormality scale
#Reference: https://content.iospress.com/articles/journal-of-alzheimers-disease/jad170991

#2.Alzheimer’s Disease Cooperative Study – Activities of Daily Living Scale (ADCS-ADL) 
#The ADCS-ADL is a 23 item scale that includes 6 BADL items and 17 IADL items
#range 0-78
#Lower score indicating greater severity 
#Reference: https://www.ncbi.nlm.nih.gov/pmc/articles/PMC4021450/

#3.Clinical Dementia Rating Scale Sum of Boxes (CDR-SOB)
#Clinical Dementia Rating Scale (CDR) is a global assessment instrument that yields global and Sum of Boxes (SOB) scores, with the global score regularly used in clinical and research settings to stage dementia severity.
#range 0-18
#higher in AD subjects
#Reference: https://www.ncbi.nlm.nih.gov/pmc/articles/PMC3409562/

#4.CDR_Total
#It was developed primarily for use in persons with dementia of the Alzheimer type (the equivalent of probable Alzheimer’s Disease) and it can also be used to stage dementia in other illnesses as well.
#range 0-3
#CDR-0.5 = very mild dementia q CDR-1 = mild, CDR-2 = moderate, CDR-3 = severe
#higher in AD subjects
#Reference: https://knightadrc.wustl.edu/cdr/pdfs/cdr_overviewtranscript-revised.pdf

#5.Hachinski
#The Hachinski ischemic score (HIS) scale is a simple clinical tool proposed and currently used for differentiating types of dementia (primary degenerative, vascular or multi-infarct, mixed type).
#THE TWO MOST FREQUENTL Y encountered types of dementia are the senile dementia of the Alzheimer type (SDAT), which accounts for approximately 50% of all patients with dementia, and the so-called multi- infarct dementia (MID), comprising about 15-20% of the total.
# Hachinski et al1 selected 13 signs and symptoms classically known and broadly indicated by Mayer Gross et al2 as signs of vascular dementia. A point value was assigned to each feature, and the final sum- mation of points resulted in an Ischemic Score. In patients with dementia, a score of 4 or less point to a diagnosis of SDAT, while scores of 7 or higher point to a diagnosis of MID.
#lower score in AD
#Reference: https://www.ahajournals.org/doi/pdf/10.1161/01.STR.14.3.399

#6.MMSE
#During the MMSE, a health professional asks a patient a series of questions designed to test a range of everyday mental skills. 
#range 0-30, The maximum MMSE score is 30 points. A score of 20 to 24 suggests mild dementia, 13 to 20 suggests moderate dementia, and less than 12 indicates severe dementia. On average, the MMSE score of a person with Alzheimer's declines about two to four points each year.
#Reference: https://www.alz.org/alzheimers-dementia/diagnosis/medical_tests

#7. NPI
#The Neuropsychiatric Inventory (NPI) is one of the most commonly used ?assessment scales for assessing symptoms in people with dementia and other neurological disorders.The NPI is a condition-specific measure designed to assess neuropsychiatric disturbances in people with AD, as well as other related dementing disorders.
# range 0-144. The total NPI score is the sum total of all of the individual domain scores (0–144).
# Reference: https://www.dovepress.com/the-merits-and-problems-of-neuropsychiatric-inventory-as-an-assessment-peer-reviewed-fulltext-article-CIA

#8.Sensory_Impairment

#9. Webster

#CERAD:  higher in normal people
# Reference: https://www.ncbi.nlm.nih.gov/pmc/articles/PMC2920638/
  #10. CERAD_B_Total 
  # range 0-15,

  #11. CERAD_E_Correct
  # range 0-10

  #12. CERAD_E_Intrusions
  # range 0-10

  #13. Can't read total (also part of CERAD)
  # range 0-10

#GDS (GeriatricDepressionScale)
#range 0-15, higher score means high depression

#Sensory impairment
# range 0-13, higher score means more impairment 
```


##normalize all the clinical data from 0-1, taking the global maxima and minima for clinical variables##
```{r}
##vector of all cognitive tests##
func.normalize <- function(data){
  normalizedData <- data
  normalizedData <- as.data.frame(normalizedData)
  if("ADAS_COG" %in% colnames(data)){
      normalizedData$ADAS_COG <- normalizedData$ADAS_COG/70
  }
  if("ADAS_total_validate" %in% colnames(data)){
      normalizedData$ADAS_total_validate <- normalizedData$ADAS_total_validate/70
  }
  if("ADAS11" %in% colnames(data)){
      normalizedData$ADAS11 <- normalizedData$ADAS11/70
  }
  if("ADAS13" %in% colnames(data)){
      normalizedData$ADAS13 <- normalizedData$ADAS13/78
  }
  if("ADAS_Memory" %in% colnames(data)){
      normalizedData$ADAS_Memory <- normalizedData$ADAS_Memory/45
  }
  if("ADAS_Language" %in% colnames(data)){
      normalizedData$ADAS_Language <- normalizedData$ADAS_Language/25
  }
  if("ADAS_Praxis" %in% colnames(data)){
      normalizedData$ADAS_Praxis <- normalizedData$ADAS_Praxis/10
  }
  if("ADAS_Concentration" %in% colnames(data)){
      normalizedData$ADAS_Concentration  <- normalizedData$ADAS_Concentration/5
  }
  if("ADCS_ADL_Total" %in% colnames(data)){
    normalizedData$ADCS_ADL_Total <- 1-normalizedData$ADCS_ADL_Total/78
  }
  if("basicADL" %in% colnames(data)){
    normalizedData$basicADL <- 1-normalizedData$basicADL/22
  }
  if("instrumentalADL" %in% colnames(data)){
    normalizedData$instrumentalADL <- 1-normalizedData$instrumentalADL/56
  }
  if("adlTotalValidate" %in% colnames(data)){
    normalizedData$adlTotalValidate <- 1-normalizedData$adlTotalValidate/78
  }
  if("ADCS_ADL" %in% colnames(data)){
    normalizedData$ADCS_ADL <- 1-normalizedData$ADCS_ADL/78
  }
  # if("advancedADL" %in% colnames(data)){
  #   normalizedData$advancedADL <- 1-normalizedData$advancedADL/"glbalscore"
  # }
  if("CDR_SOB"%in% colnames(data)){
      normalizedData$CDR_SOB <- normalizedData$CDR_SOB/18
 }
  if("CDRSB" %in% colnames(data)){
      normalizedData$CDRSB <- normalizedData$CDRSB/18
  }
  if("CDR_Total" %in% colnames(data)){
      normalizedData$CDR_Total <- normalizedData$CDR_Total/3
  }
  if("Hachinski" %in% colnames(data)){
     normalizedData$Hachinski <- 1-normalizedData$Hachinski/8
  }
  if("MMSE" %in% colnames(data)){
      normalizedData$MMSE <- 1-normalizedData$MMSE/30
  }
  if("CERAD_B_Total" %in% colnames(data)){
      normalizedData$CERAD_B_Total <- 1-normalizedData$CERAD_B_Total/15
  }
  if("CERAD_E_Correct" %in% colnames(data)){
    normalizedData$CERAD_E_Correct <- 1-normalizedData$CERAD_E_Correct/10
  }
  if("CERAD_E_Intrusions" %in% colnames(data)){
      normalizedData$CERAD_E_Intrusions <- 1-normalizedData$CERAD_E_Intrusions/10-0
  }
  if("Cant_Read_Total" %in% colnames(data)){
    normalizedData$Cant_Read_Total <- 1-normalizedData$Cant_Read_Total/10
  }
  if("Geriatric_Depression" %in% colnames(data)){
    normalizedData$Geriatric_Depression <- normalizedData$Geriatric_Depression/15     
  }
  if("Sensory_Impairment" %in% colnames(data)){
      normalizedData$Sensory_Impairment <- normalizedData$Sensory_Impairment/13   
  } 
   if("walking" %in% colnames(data)){
      normalizedData$walking <-  1-normalizedData$walking/3
   } 
   if("telephone" %in% colnames(data)){
      normalizedData$telephone <- 1-(normalizedData$telephone-1)/(5-1)
   } 
   if("personalBelongings" %in% colnames(data)){
      normalizedData$personalBelongings <- 1-(normalizedData$personalBelongings-1)/(3-1)
   } 
   if("travel" %in% colnames(data)){
      normalizedData$travel <- 1-(normalizedData$travel-1)/(4-1)
   } 
   if("appointments" %in% colnames(data)){
      normalizedData$appointments <- 1-normalizedData$appointments/3  
   } 
   if("talking" %in% colnames(data)){
      normalizedData$talking <- 1-normalizedData$talking/3
   } 
   if("reading" %in% colnames(data)){
      normalizedData$reading <- 1-normalizedData$reading/2
   } 
   if("writing" %in% colnames(data)){
      normalizedData$writing <-  1-(normalizedData$writing-1)/(3-1)
   } 
   if("householdApplicances" %in% colnames(data)){
      normalizedData$householdApplicances <- 1-(normalizedData$householdApplicances-1)/(4-1)
  } 
  return(normalizedData)
}
```

##removing IDs where all values are missing for a particular feature##
```{r}
func.rem.na = function(data){
  demographics = c("Sex", "APOE", "Fulltime_Education_Years", "Marital_Status")
  featureNames = setdiff(colnames(data), c(demographics, c("Subject_ID", "Age", "Diagnosis", "Visit", "Month", "ID")))
  #print(featureNames)
  indxAll = c()
  for(names in featureNames){
    aggDf = aggregate(get(names) ~ ID, data = data, paste, collapse = ",", na.action=NULL)
    names(aggDf)[names(aggDf) == "get(names)"] = "feature"
    indx = aggDf[!grepl("[0-9].*[0-9]", aggDf$feature),"ID"]
    indxAll = c(indxAll, indx)
    #print(indxAll)
  }
  indxAll = unique(indxAll)
  #print(indxAll)
  #print(length(indxAll))
  data = data[!data$ID %in% indxAll,]
  return(data)
}
```

##data to be entered in the model##
```{r}
##include ID, age and biomarker, each row will be the visit
dataForLeaspy <- function(normData){
  normData$ID <- as.numeric(factor(normData$Subject_ID, levels=unique(normData$Subject_ID)))
  print("efefefef")
  print(colnames(normData))
  normData <- func.rem.na(normData)
  print("length after removing patients with one time point or one visit")
  print(length(unique(normData$Subject_ID)))
  #print(table(normData$Visit))
  #print(table(subset(normData,normData$Month == 0)["Diagnosis"]))
  if(type_of_data == "WithADLDementia"){
      inputDataANM <- normData[,c("ID","Age","ADAS_COG","ADAS_Memory","ADAS_Language", "ADAS_Praxis",
  "CDR_SOB", "MMSE","ADCS_ADL","basicADL", "instrumentalADL")]
  }
  if(type_of_data %in% c("MCIandDementia", "Control")){
     inputDataANM <- normData[,c("ID","Age", "CDR_SOB", "CDR_Total", "MMSE")]
  }
  if(type_of_data == "DeNovo"){
      inputDataANM <- normData[,c("ID","Age","ADAS_COG","ADAS_Memory","ADAS_Language", "ADAS_Praxis",
  "CDR_SOB", "MMSE")]
  }
  if(type_of_data == "WithDigital"){
    inputDataANM <- normData[,c("ID","Age","ADAS_COG", "CDR_SOB", "MMSE", "walking", "telephone", "personalBelongings", "travel", "appointments", "reading", "writing", "householdApplicances")]
  }
  colnames(inputDataANM)[colnames(inputDataANM) == "Age"] = "TIME"
  #save.image(paste(getwd(), "/Scripts/dataPreparationANM.RData", sep = ""))
  return(list(inputDataANM, normData))
}
```

##main function
```{r}
dataPrepare <- function(inputData){
  if(type_of_data %in% c("MCIandDementia", "Control")){
      adasMerge = inputData
      dataNoSingleTimePoint <- func.del.patients.single.time.point(adasMerge)
  } 
  if(type_of_data == "DeNovo"){
    adasMerge <- merge.adas(inputData)
    print("length adas merge")
    print(colnames(adasMerge))
    print(length(unique(adasMerge$Subject_ID)))
    dataNoSingleTimePoint <- func.del.patients.single.time.point(adasMerge) 
 }
 if(type_of_data == "WithADLDementia"){
    print("meemem")
  adasMerge <- merge.adas(inputData)
  adcsMerge <- merge.adcs(adasMerge)
  print("length adcs merge")
  print(length(unique(adcsMerge$Subject_ID)))
  print(colnames(adcsMerge))
   dataNoSingleTimePoint <- func.del.patients.single.time.point(adcsMerge)
 }
  normData <- func.normalize(dataNoSingleTimePoint)
  print("length after removing patients with one time point or one visit")
  print(length(unique(dataNoSingleTimePoint$Subject_ID)))
  print(nrow(dataNoSingleTimePoint))
  print(diag.density(dataNoSingleTimePoint))
  #print("4th function")
  #print(normData)
  outputData <- dataForLeaspy(normData)
  #print(outputData)
  return(outputData)
}
```

##call the main function
```{r}
outputData <- dataPrepare(finalDf)
varData <- outputData[[1]]
cofactorData <- outputData[[2]]
##missing value percentage##
print(colMeans(is.na(varData)))
cofactorData$APOE[cofactorData$APOE %in% c("E2E2", "E2E3", "E3E3")] <- "No risk"
cofactorData$APOE[cofactorData$APOE %in% c("E2E4","E3E4", "E4E4")] <- "At Risk"
cofactorData$APOE <- as.factor(cofactorData$APOE)

cofactorData$Education <- as.numeric(cofactorData$Education)

cofactorData$Education <- ifelse(cofactorData$Education > 9 , "More Educated", "Less Educated")
cofactorData$Education <- as.factor(cofactorData$Education)


if(type_of_data == "DeNovo"){
  write.table(varData, file = paste(getwd(), "/ResultsUpdated/ANMOnlyDementia/inputDataANMDeNovo.csv", sep   = "") ,row.names=FALSE,   sep=",")
  write.table(cofactorData, file = paste(getwd(), "/ResultsUpdated/ANMOnlyDementia/cofactorDataANMDeNovo.csv", sep = "")     ,row.names=FALSE, sep=",")
}
if(type_of_data == "MCIandDementia"){
  write.table(varData, file = paste(getwd(), "/ResultsUpdated/ANMMCIandDementia/inputDataANMMCIDementia.csv", sep   = "") ,row.names=FALSE,   sep=",")
  write.table(cofactorData, file = paste(getwd(), "/ResultsUpdated/ANMMCIandDementia/cofactorDataANMMCIDementia.csv", sep = "")     ,row.names=FALSE, sep=",")
}
if(type_of_data == "Control"){
  write.table(varData, file = paste(getwd(), "/ResultsUpdated/ANMOnlyControl/inputDataANMControl.csv", sep   = "") ,row.names=FALSE,   sep=",")
  write.table(cofactorData, file = paste(getwd(), "/ResultsUpdated/ANMOnlyControl/cofactorDataANMControl.csv", sep = "")     ,row.names=FALSE, sep=",")
}
if(type_of_data == "WithADLDementia"){
  write.table(varData, file = paste(getwd(), "/ResultsUpdated/ANMwithADLDementia/inputDataANMwithADLDementia.csv", sep   = "") ,row.names=FALSE,   sep=",")
  write.table(cofactorData, file = paste(getwd(), "/ResultsUpdated/ANMwithADLDementia/cofactorDataANMwithADLDementia.csv", sep = "")     ,row.names=FALSE, sep=",")
save.image(paste(getwd(), "/Scripts/dataPreparation.RData", sep = ""))
}
```









